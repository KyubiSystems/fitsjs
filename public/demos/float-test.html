<!DOCTYPE html>
<html>
<head>
  <title>Demo &mdash; FITS Image</title>
  <script type="text/javascript" src="javascript/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="javascript/jquery-ui-1.8.21.custom.min.js"></script>
  
  <link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/application.css" type="text/css" charset="utf-8">
  <link rel="stylesheet" href="css/jquery-ui-1.8.21.custom.css" type="text/css" charset="utf-8">
  
  <script type="text/javascript" src="../application.js"></script>
  <script type="text/javascript" src="./webgl-utils.js"></script>
  <script type="text/javascript" src="./webgl-float-test.js"></script>

  <script id="2d-vertex-shader" type="x-shader/x-vertex">
  attribute vec2 a_position;
  void main() {
      gl_Position = vec4(a_position, 0, 1);
  }
  </script>
  <script id="2d-fragment-shader-linear" type="x-shader/x-fragment">
  precision mediump float;
  
  uniform vec2 u_resolution;
  uniform sampler2D u_tex;
  uniform vec2 u_extremes;
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v = texture2D(u_tex, texCoord);
      
      float min = u_extremes[0];
      float max = u_extremes[1];
      float pixel = (pixel_v[0] - min) / (max - min);
      
      gl_FragColor = vec4(pixel, pixel, pixel, 1.0);
  }
  </script>
  
  <script id="2d-fragment-shader-logarithm" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 u_resolution;
  uniform sampler2D u_tex;
  uniform vec2 u_extremes;
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v = texture2D(u_tex, texCoord);
      
      float min = log(u_extremes[0]);
      float max = log(u_extremes[1]);
      
      float pixel = (log(pixel_v[0]) - min) / (max - min);
      
      gl_FragColor = vec4(pixel, pixel, pixel, 1.0);
  }
  </script>
  
  <script id="2d-fragment-shader-sqrt" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 u_resolution;
  uniform sampler2D u_tex;
  uniform vec2 u_extremes;
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v = texture2D(u_tex, texCoord);
      
      float min = sqrt(u_extremes[0]);
      float max = sqrt(u_extremes[1]);
      
      float pixel = (sqrt(pixel_v[0]) - min) / (max - min);
      
      gl_FragColor = vec4(pixel, pixel, pixel, 1.0);
  }
  </script>

  <script id="2d-fragment-shader-arcsinh" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 u_resolution;
  uniform sampler2D u_tex;
  uniform vec2 u_extremes;
  
  float arcsinh(float value) {
    return log(value + sqrt(1.0 + value * value));
  }
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v = texture2D(u_tex, texCoord);
      
      float min = arcsinh(u_extremes[0]);
      float max = arcsinh(u_extremes[1]);
      float value = arcsinh(pixel_v[0]);
      
      float pixel = (value - min) / (max - min);
      
      gl_FragColor = vec4(pixel, pixel, pixel, 1.0);
  }
  </script>
  
  <script id="2d-fragment-shader-power" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 u_resolution;
  uniform sampler2D u_tex;
  uniform vec2 u_extremes;
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v = texture2D(u_tex, texCoord);
      
      float min = pow(u_extremes[0], 2.0);
      float max = pow(u_extremes[1], 2.0);
      
      float pixel = (pow(pixel_v[0], 2.0) - min) / (max - min);
      
      gl_FragColor = vec4(pixel, pixel, pixel, 1.0);
  }
  </script>
  
  <script id="2d-fragment-shader-composite" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 u_resolution;
  uniform sampler2D u_tex_g;
  uniform sampler2D u_tex_r;
  uniform sampler2D u_tex_i;
  uniform vec2 u_extremes;
  
  float arcsinh(float value) {
    return log(value + sqrt(1.0 + value * value));
  }
  
  // float f(float minimum, float maximum, float value) {
  //   float pixel = clamp(value, minimum, maximum);
  //   return arcsinh(pixel - minimum) / arcsinh(maximum - minimum);
  // }
  
  float f(float minimum, float maximum, float value) {
    float pixel = clamp(value, minimum, maximum);
    float alpha = 0.02;
    float Q = 8.0;
    return arcsinh(alpha * Q * (pixel - minimum)) / Q;
  }
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v_g = texture2D(u_tex_g, texCoord);
      vec4 pixel_v_r = texture2D(u_tex_r, texCoord);
      vec4 pixel_v_i = texture2D(u_tex_i, texCoord);
      
      float minimum = u_extremes[0];
      float maximum = u_extremes[1];
      float g = pixel_v_g[0];
      float r = pixel_v_r[0];
      float i = pixel_v_i[0];
      float I = (g + r + i) / 3.0;
      float fI = f(minimum, maximum, I);
      float fII = fI / I;
      
      float R = i * fII;
      float G = r * fII;
      float B = g * fII;

      float RGBmax = max(max(R, G), B);

      if (RGBmax > 1.0) {
        R = R / RGBmax;
        G = G / RGBmax;
        B = B / RGBmax;
      }
      if (I == 0.0) {
        R = 0.0;
        G = 0.0;
        B = 0.0;
      }
      
      gl_FragColor = vec4(R, G, B, 1.0);
  }
  </script>
  
  <script id="2d-fragment-shader" type="x-shader/x-fragment">
  precision mediump float;
  uniform vec2 u_resolution;
  uniform sampler2D u_tex;
  uniform vec2 u_extremes;
  
  subroutine vec3 shadeModelType( vec4 position, vec3 normal);
  
  // subroutine float stretchType(float value);
  // subroutine uniform stretchType stretch;

  // subroutine (stretchType)
  // float linear(float value) {
  //   return value;
  // }
  // 
  // subroutine (stretchType)
  // float logarithm(float value) {
  //   return log(value);
  // }
  // 
  // subroutine (stretchType)
  // float squareroot(float value) {
  //   return sqrt(value);
  // }
  // 
  // subroutine (stretchType)
  // float arcsinh(float value) {
  //   return log(value + sqrt(1.0 + value * value));
  // }
  // 
  // subroutine (stretchType)
  // float power(float value) {
  //   return pow(value, 2);
  // }
  
  void main() {
      vec2 texCoord = gl_FragCoord.xy / u_resolution;
      vec4 pixel_v = texture2D(u_tex, texCoord);

      // float min = stretch(u_extremes[0]);
      // float max = stretch(u_extremes[1]);
      // float pixel = (stretch(pixel_v[0]) - min) / (max - min);
      float min = u_extremes[0];
      float max = u_extremes[1];
      float pixel = (pixel_v[0] - min) / (max - min);
      
      gl_FragColor = vec4(pixel, pixel, pixel, 1.0);
  }
  </script>
  
</head>
<body>
  <header>
    <img id="logo" src="../logo.png" />
  </header>
  <div id="ui">
    <select id="filter">
    </select>
    <select id="stretch">
      <option value="2d-fragment-shader-linear">Linear</option>
      <option value="2d-fragment-shader-logarithm">Logarithm</option>
      <option value="2d-fragment-shader-sqrt">Square Root</option>
      <option value="2d-fragment-shader-arcsinh">Arcsinh</option>
      <option value="2d-fragment-shader-power">Power</option>
    </select>
    <button id="gri">g-r-i</button>
    <div id="slider-range"></div>
  </div>
  <canvas id="canvas"></canvas>
</body>
</html>